import test from "node:test";
import assert from "node:assert/strict";
import { handleGetMyDashboard } from "@/lib/my-dashboard-route";

const now = new Date();
const day = (daysAgo: number) => new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - daysAgo));

function baseDeps() {
  return {
    requireAuth: async () => ({ id: "user-1" }),
    findOwnedArtistByUserId: async () => ({
      id: "artist-1",
      name: "Artist",
      slug: "artist",
      bio: "bio",
      websiteUrl: "https://artist.test",
      featuredAssetId: "asset-1",
      avatarImageUrl: null,
      featuredAsset: { url: "https://img/avatar.jpg" },
    }),
    listManagedVenuesByUserId: async () => [{ id: "venue-1" }],
    listManagedVenueDetailsByUserId: async () => [],
    listArtworksByArtistId: async () => [],
    listEventsByContext: async () => [],
    listArtworkViewDailyRows: async () => [],
    listRecentAuditActivity: async () => [],
  };
}

test("/api/my/dashboard returns 401 when unauthenticated", async () => {
  const deps = baseDeps();
  deps.requireAuth = async () => { throw new Error("unauthorized"); };

  const res = await handleGetMyDashboard(deps);
  assert.equal(res.status, 401);
});

test("/api/my/dashboard returns onboarding payload when user has no artist", async () => {
  const deps = baseDeps();
  deps.findOwnedArtistByUserId = async () => null;

  const res = await handleGetMyDashboard(deps);
  assert.equal(res.status, 200);
  const body = await res.json();
  assert.equal(body.needsOnboarding, true);
  assert.equal(body.nextHref, "/my/artist");
});

test("/api/my/dashboard computes stats, inbox counts, and top artworks ordering", async () => {
  const deps = baseDeps();
  deps.listManagedVenuesByUserId = async () => [{ id: "venue-1" }, { id: "venue-2" }, { id: "venue-3" }];
  deps.listManagedVenueDetailsByUserId = async () => [
    { id: "venue-1", slug: "venue-one", name: "Venue One", city: "Paris", country: "FR", isPublished: true, featuredAssetId: "asset-1", featuredAsset: { url: "https://img/v1.jpg" }, submissions: [] },
    { id: "venue-2", slug: null, name: "Venue Two", city: null, country: null, isPublished: false, featuredAssetId: null, featuredAsset: null, submissions: [{ status: "SUBMITTED" }] },
    { id: "venue-3", slug: "venue-three", name: "Venue Three", city: "Berlin", country: "DE", isPublished: false, featuredAssetId: null, featuredAsset: null, submissions: [{ status: "REJECTED" }] },
  ];
  deps.listArtworksByArtistId = async () => [
    { id: "a1", title: "Draft", slug: "draft", isPublished: false, featuredAssetId: null, updatedAt: day(1), featuredAsset: null, images: [], _count: { images: 0 } },
    { id: "a2", title: "Published High", slug: "high", isPublished: true, featuredAssetId: "asset-a2", updatedAt: day(2), featuredAsset: { url: "https://img/a2.jpg" }, images: [{ asset: { url: "https://img/a2.jpg" } }], _count: { images: 1 } },
  ];
  deps.listEventsByContext = async () => [
    { id: "e1", title: "No venue", slug: "event-1", startAt: day(-5), updatedAt: day(0), isPublished: false, venueId: null, venue: null },
    { id: "e2", title: "Venue set", slug: "event-2", startAt: day(-10), updatedAt: day(4), isPublished: true, venueId: "venue-1", venue: { name: "Hall" } },
  ];
  deps.listArtworkViewDailyRows = async () => [
    { entityId: "a2", day: day(0), views: 10 },
    { entityId: "a2", day: day(5), views: 6 },
  ];
  deps.findOwnedArtistByUserId = async () => ({
    id: "artist-1",
    name: "Artist",
    slug: "artist",
    bio: "",
    websiteUrl: "https://artist.test",
    featuredAssetId: null,
    avatarImageUrl: null,
    featuredAsset: null,
  });

  const res = await handleGetMyDashboard(deps);
  const body = await res.json();

  assert.equal(body.stats.artworks.total, 2);
  assert.equal(body.stats.artworks.drafts, 1);
  assert.equal(body.stats.artworks.missingCover, 1);
  assert.equal(body.stats.events.missingVenue, 1);
  assert.equal(body.stats.venues.submissionsPending, 1);

  assert.deepEqual(
    body.actionInbox.map((item: { id: string }) => item.id),
    [
      "venue-needs-edits",
      "venue-submitted",
      "artwork-missing-cover",
      "venue-missing-cover",
      "artwork-drafts",
      "event-drafts",
      "events-missing-venue",
      "profile-missing-avatar",
    ],
  );

  assert.equal(body.actionInbox.find((item: { id: string }) => item.id === "venue-needs-edits")?.href, "/my/venues?filter=needsEdits");
  assert.equal(body.actionInbox.find((item: { id: string }) => item.id === "venue-submitted")?.href, "/my/venues?filter=submitted");
  assert.equal(body.actionInbox.find((item: { id: string }) => item.id === "artwork-missing-cover")?.href, "/my/artwork?filter=missingCover");
  assert.equal(body.actionInbox.find((item: { id: string }) => item.id === "profile-missing-avatar")?.href, "/my/artist#avatar");
  assert.equal(body.actionInbox.find((item: { id: string }) => item.id === "profile-missing-bio"), undefined);
  assert.equal(body.topArtworks30[0].id, "a2");
});

test("/api/my/dashboard prefers allowed audit activity in recent list", async () => {
  const deps = baseDeps();
  deps.listRecentAuditActivity = async () => [
    { action: "ARTWORK_UPDATED", targetId: "artwork-1", createdAt: day(0) },
    { action: "IGNORED_EVENT", targetId: "event-1", createdAt: day(1) },
  ];

  const res = await handleGetMyDashboard(deps);
  const body = await res.json();
  assert.equal(body.recent.length, 1);
  assert.match(body.recent[0].label, /Artwork Updated/i);
});

test("/api/my/dashboard includes scoped venue entities and venue stats", async () => {
  const deps = baseDeps();
  deps.listManagedVenuesByUserId = async () => [{ id: "venue-1" }, { id: "venue-2" }, { id: "venue-3" }];
  deps.listManagedVenueDetailsByUserId = async () => [
    { id: "venue-1", slug: "venue-one", name: "Venue One", city: "Paris", country: "FR", isPublished: true, featuredAssetId: "asset-1", featuredAsset: { url: "https://img/v1.jpg" }, submissions: [] },
    { id: "venue-2", slug: null, name: "Venue Two", city: null, country: null, isPublished: false, featuredAssetId: null, featuredAsset: null, submissions: [{ status: "SUBMITTED" }] },
    { id: "venue-3", slug: "venue-three", name: "Venue Three", city: "Berlin", country: "DE", isPublished: false, featuredAssetId: null, featuredAsset: null, submissions: [{ status: "REJECTED" }] },
    { id: "venue-unmanaged", slug: "hidden", name: "Hidden Venue", city: null, country: null, isPublished: true, featuredAssetId: null, featuredAsset: null, submissions: [] },
  ];

  const res = await handleGetMyDashboard(deps);
  const body = await res.json();

  assert.equal(body.entities.venues.length, 3);
  assert.deepEqual(body.entities.venues.map((venue: { id: string }) => venue.id), ["venue-1", "venue-2", "venue-3"]);
  assert.equal(body.stats.venues.totalManaged, 3);
  assert.equal(body.stats.venues.published, 1);
  assert.equal(body.stats.venues.drafts, 2);
  assert.equal(body.stats.venues.submissionsPending, 1);
  assert.equal(body.links.venuesNewHref, "/my/venues/new");
  assert.equal(body.links.venuesHref, "/my/venues");
});

test("/api/my/dashboard falls back to synthesized recent updates", async () => {
  const deps = baseDeps();
  deps.listArtworksByArtistId = async () => [
    { id: "a1", title: "Draft", slug: "draft", isPublished: false, featuredAssetId: null, updatedAt: day(0), featuredAsset: null, images: [], _count: { images: 0 } },
  ];
  deps.listEventsByContext = async () => [
    { id: "e1", title: "Event", slug: "event-1", startAt: day(-1), updatedAt: day(1), isPublished: false, venueId: null, venue: null },
  ];

  const res = await handleGetMyDashboard(deps);
  const body = await res.json();
  assert.equal(body.recent.length, 2);
  assert.match(body.recent[0].label, /Updated artwork|Updated event/);
});
