name: Prisma Migrate (Neon)

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "prisma/migrations/**"
      - "prisma/schema.prisma"

jobs:
  migrate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
      NEON_PROJECT_ID: ${{ secrets.NEON_PROJECT_ID }}
      NEON_BRANCH_NAME: main

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9.15.9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Versions
        run: |
          echo "Git SHA: ${GITHUB_SHA}"
          node -v
          pnpm -v

      - run: pnpm install --frozen-lockfile
      - run: pnpm prisma --version
      - run: pnpm prisma:check-migration-order

      - name: Fetch Neon connection URLs
        id: neon
        run: |
          max_attempts=24
          for attempt in $(seq 1 "$max_attempts"); do
            echo "Fetching Neon connection URLs attempt ${attempt}/${max_attempts}..."

            set +e
            neon_err_log="$(mktemp)"
            node scripts/neon/get-connection-urls.mjs --branch-name "$NEON_BRANCH_NAME" 2>"$neon_err_log"
            status=$?
            set -e

            if [ "$status" -ne 0 ]; then
              fail_reason="$(sed -n 's/.*FAIL_REASON=\([^ ]*\).*/\1/p' "$neon_err_log" | tail -n1)"
              echo "Neon URL fetch FAIL_REASON=${fail_reason:-UNKNOWN}"
              cat "$neon_err_log" >&2
            fi
            rm -f "$neon_err_log"

            if [ "$status" -eq 0 ]; then
              if grep -q '^database_url=' "$GITHUB_OUTPUT" && grep -q '^direct_url=' "$GITHUB_OUTPUT"; then
                echo "Connection URLs retrieved successfully."
                exit 0
              fi
              echo "get-connection-urls succeeded but required outputs were not set yet."
            elif [ "$status" -eq 2 ]; then
              exit 2
            fi

            if [ "$attempt" -lt "$max_attempts" ]; then
              echo "Connection URLs not ready yet; retrying in 5s..."
              sleep 5
            fi
          done

          echo "Failed to fetch Neon connection URLs (database_url/direct_url) after ${max_attempts} attempts."
          exit 1

      - name: Validate DB URL hosts
        env:
          DATABASE_URL: ${{ steps.neon.outputs.database_url }}
          DIRECT_URL: ${{ steps.neon.outputs.direct_url }}
        run: |
          node -e "console.log('DATABASE_URL host:', new URL(process.env.DATABASE_URL).hostname)"
          node -e "console.log('DIRECT_URL host:', new URL(process.env.DIRECT_URL).hostname)"
          node -e "process.exit(new URL(process.env.DIRECT_URL).hostname.includes('-pooler') ? 1 : 0)"

      - name: Migrate deploy
        env:
          DATABASE_URL: ${{ steps.neon.outputs.database_url }}
          DIRECT_URL: ${{ steps.neon.outputs.direct_url }}
        run: pnpm prisma migrate deploy

      - name: Check migration status after deploy
        env:
          DATABASE_URL: ${{ steps.neon.outputs.database_url }}
          DIRECT_URL: ${{ steps.neon.outputs.direct_url }}
        run: pnpm prisma migrate status

      - name: Generate Prisma Client
        run: pnpm prisma generate

      - name: Verify tables exist
        env:
          DIRECT_URL: ${{ steps.neon.outputs.direct_url }}
        run: |
          pnpm prisma db execute --url "$DIRECT_URL" --stdin <<'SQL'
          select to_regclass('public._prisma_migrations') as prisma_migrations_table;
          select table_schema, table_name
          from information_schema.tables
          where table_schema='public'
          order by table_name;
          SQL
