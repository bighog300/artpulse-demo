name: Prisma Migrate (Neon)

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "prisma/migrations/**"
      - "prisma/schema.prisma"

jobs:
  migrate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9.15.9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - run: pnpm install --frozen-lockfile
      - run: pnpm prisma generate

      # Safe debug: prints only hostnames (no secrets)
      - name: Debug DB URLs (safe)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }} # should be Neon pooled
          DIRECT_URL: ${{ secrets.DIRECT_URL }}     # should be Neon direct
        run: |
          node - <<'NODE'
          for (const k of ["DATABASE_URL","DIRECT_URL"]) {
            const v = process.env[k] || "";
            console.log(k, "present:", !!v, "len:", v.length);
            if (v) {
              try { console.log(k, "host:", new URL(v).host); }
              catch { console.log(k, "not a valid URL"); process.exit(1); }
            }
          }
          NODE

      - name: Migrate deploy (force direct Neon URL)
        env:
          # Force Prisma datasource url + directUrl to direct for DDL/migrations
          DATABASE_URL: ${{ secrets.DIRECT_URL }}
          DIRECT_URL: ${{ secrets.DIRECT_URL }}
        run: pnpm prisma migrate deploy

      - name: Verify tables exist
        env:
          DIRECT_URL: ${{ secrets.DIRECT_URL }}
        run: |
          pnpm prisma db execute --url "$DIRECT_URL" --stdin <<'SQL'
          select to_regclass('public._prisma_migrations') as prisma_migrations_table;
          select table_schema, table_name
          from information_schema.tables
          where table_schema='public'
          order by table_name;
          SQL
