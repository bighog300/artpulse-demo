name: Preview DB (Neon)

concurrency:
  group: preview-db-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  migrate_preview_db:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
      NEON_PROJECT_ID: ${{ secrets.NEON_PROJECT_ID }}
      PR_BRANCH_NAME: pr-${{ github.event.pull_request.number }}
      PARENT_NEON_BRANCH: main
      AUTH_SECRET: ci-preview-auth-secret
    outputs:
      database_url: ${{ steps.neon-urls.outputs.database_url }}
      direct_url: ${{ steps.neon-urls.outputs.direct_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Vercel secrets
        id: vercel_secrets
        shell: bash
        run: |
          ok=true
          [ -n "${{ secrets.VERCEL_TOKEN }}" ] || ok=false
          [ -n "${{ secrets.VERCEL_ORG_ID }}" ] || ok=false
          [ -n "${{ secrets.VERCEL_PROJECT_ID }}" ] || ok=false
          echo "has_vercel_secrets=$ok" >> "$GITHUB_OUTPUT"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Versions
        run: |
          echo "Git SHA: ${GITHUB_SHA}"
          node -v
          pnpm -v

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Print Prisma version
        run: pnpm prisma --version

      - name: Ensure preview Neon branch exists
        run: node scripts/neon/create-branch.mjs --branch-name "$PR_BRANCH_NAME" --parent-branch "$PARENT_NEON_BRANCH"

      - name: Wait until preview Neon branch is visible
        run: |
          max_attempts=20
          for attempt in $(seq 1 "$max_attempts"); do
            echo "Checking Neon branch visibility attempt ${attempt}/${max_attempts}..."

            if node --input-type=module -e 'import { getBranchByName } from "./scripts/neon/_neon-api.mjs"; const b=await getBranchByName({ projectId: process.env.NEON_PROJECT_ID, apiKey: process.env.NEON_API_KEY, branchName: process.env.PR_BRANCH_NAME }); if (!b) process.exit(1);'; then
              echo "Branch is visible in Neon API."
              exit 0
            fi

            if [ "$attempt" -lt "$max_attempts" ]; then
              sleep 3
            fi
          done

          echo "Neon branch was not visible after ${max_attempts} attempts."
          exit 1

      - name: Fetch preview DB connection URLs
        id: neon-urls
        run: |
          max_attempts=24
          for attempt in $(seq 1 "$max_attempts"); do
            echo "Fetching Neon connection URLs attempt ${attempt}/${max_attempts}..."

            set +e
            neon_err_log="$(mktemp)"
            node scripts/neon/get-connection-urls.mjs --branch-name "$PR_BRANCH_NAME" 2>"$neon_err_log"
            status=$?
            set -e

            if [ "$status" -ne 0 ]; then
              fail_reason="$(sed -n 's/.*FAIL_REASON=\([^ ]*\).*/\1/p' "$neon_err_log" | tail -n1)"
              echo "Neon URL fetch FAIL_REASON=${fail_reason:-UNKNOWN}"
              cat "$neon_err_log" >&2
            fi
            rm -f "$neon_err_log"

            if [ "$status" -eq 0 ]; then
              if grep -q '^database_url=' "$GITHUB_OUTPUT" && grep -q '^direct_url=' "$GITHUB_OUTPUT"; then
                echo "Connection URLs retrieved successfully."
                exit 0
              fi
              echo "get-connection-urls succeeded but required outputs were not set yet."
            elif [ "$status" -eq 2 ]; then
              exit 2
            fi

            if [ "$attempt" -lt "$max_attempts" ]; then
              echo "Connection URLs not ready yet; retrying in 5s..."
              sleep 5
            fi
          done

          echo "Failed to fetch Neon connection URLs (database_url/direct_url) after ${max_attempts} attempts."
          exit 1

      - name: Validate DB URL hosts
        env:
          DATABASE_URL: ${{ steps.neon-urls.outputs.database_url }}
          DIRECT_URL: ${{ steps.neon-urls.outputs.direct_url }}
        run: |
          node -e "console.log('DATABASE_URL host:', new URL(process.env.DATABASE_URL).hostname)"
          node -e "console.log('DIRECT_URL host:', new URL(process.env.DIRECT_URL).hostname)"
          node -e "process.exit(new URL(process.env.DIRECT_URL).hostname.includes('-pooler') ? 1 : 0)"

      - name: Deploy migrations to preview DB
        env:
          DATABASE_URL: ${{ steps.neon-urls.outputs.database_url }}
          DIRECT_URL: ${{ steps.neon-urls.outputs.direct_url }}
        run: pnpm prisma migrate deploy

      - name: Check migration status after deploy
        env:
          DATABASE_URL: ${{ steps.neon-urls.outputs.database_url }}
          DIRECT_URL: ${{ steps.neon-urls.outputs.direct_url }}
        run: pnpm prisma migrate status

      - name: Generate Prisma Client
        run: pnpm prisma generate

      - name: Seed preview DB
        env:
          DATABASE_URL: ${{ steps.neon-urls.outputs.database_url }}
          DIRECT_URL: ${{ steps.neon-urls.outputs.direct_url }}
          SEED_ENABLED: "true"
          APP_ENV: preview
        run: pnpm db:seed

      - name: Update Vercel Preview env vars for this git branch
        if: ${{ steps.vercel_secrets.outputs.has_vercel_secrets == 'true' }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          PR_GIT_BRANCH: ${{ github.head_ref }}
          DATABASE_URL: ${{ steps.neon-urls.outputs.database_url }}
          DIRECT_URL: ${{ steps.neon-urls.outputs.direct_url }}
        run: |
          pnpm dlx vercel env rm DATABASE_URL preview --yes --git-branch "$PR_GIT_BRANCH" --token "$VERCEL_TOKEN" >/dev/null 2>&1 || true
          pnpm dlx vercel env rm DIRECT_URL preview --yes --git-branch "$PR_GIT_BRANCH" --token "$VERCEL_TOKEN" >/dev/null 2>&1 || true
          printf "%s" "$DATABASE_URL" | pnpm dlx vercel env add DATABASE_URL preview --git-branch "$PR_GIT_BRANCH" --token "$VERCEL_TOKEN"
          printf "%s" "$DIRECT_URL" | pnpm dlx vercel env add DIRECT_URL preview --git-branch "$PR_GIT_BRANCH" --token "$VERCEL_TOKEN"
          echo "set-env OK: Vercel preview env vars updated for branch $PR_GIT_BRANCH"

      - name: Skip Vercel steps (missing secrets)
        if: ${{ steps.vercel_secrets.outputs.has_vercel_secrets != 'true' }}
        run: echo "Skipping Vercel-related steps because Vercel secrets are not available."

  delete_preview_db:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
      NEON_PROJECT_ID: ${{ secrets.NEON_PROJECT_ID }}
      PR_BRANCH_NAME: pr-${{ github.event.pull_request.number }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Skip when Neon secrets are unavailable
        run: |
          if [ -z "$NEON_API_KEY" ] || [ -z "$NEON_PROJECT_ID" ]; then
            echo "NEON_API_KEY or NEON_PROJECT_ID is missing; skipping preview branch deletion."
            exit 0
          fi

      - name: Delete preview Neon branch
        run: node scripts/neon/delete-branch.mjs --branch-name "$PR_BRANCH_NAME" --if-exists
