# Performance audit snapshot (2026-02-16)

## Scope
- `/api/events` (default, query, tags, date range, geo bbox)
- `/api/trending/events`
- `/api/recommendations/events`
- Venue detail upcoming query
- Artist detail upcoming/past query

## Explain targets added
The admin explain catalog now includes:
- `events_list`
- `events_query`
- `events_tags`
- `events_date_range`
- `events_geo_bbox`
- `trending_groupby`
- `trending_event_lookup`
- `recommendations_seed`
- `venue_upcoming`
- `artist_upcoming`
- `artist_past`

These plans can be captured with:

```bash
PERF_EXPLAIN_ENABLED=true PERF_ALLOW_ANALYZE=true pnpm dev
# then use /admin/perf or POST /api/admin/perf/explain
```

## Local capture status
- In this environment, no `DATABASE_URL` was configured, so live `EXPLAIN ANALYZE` snapshots could not be executed.
- The query catalog and migration/index changes were prepared to support reproducible capture in a connected environment.

## Expected bottlenecks identified from query patterns
1. `/api/events` geo flow did post-filtering in memory after `take=limit+1`, causing underfilled pages and false end-of-results.
2. Trending favorites 14-day group-by needed a read-side index on `(targetType, createdAt, targetId)`.
3. Event primary image include needed `(eventId, sortOrder)` on `EventImage`.
4. Artist relation traversal benefits from `EventArtist(artistId, eventId)` for faster joins.
5. Cursor-sort on events benefits from `Event(isPublished, startAt, id)`.

## Perf harness
Use `scripts/perf-smoke.mjs`:

```bash
pnpm perf:smoke
# optionally
PERF_BASE_URL=https://<branch-url> pnpm perf:smoke
```

Recommendations endpoint requires auth; script marks 401/403 as skipped.
