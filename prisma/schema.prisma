generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  EDITOR
  ADMIN
}

enum VenueMembershipRole {
  OWNER
  EDITOR
}

enum VenueInviteStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}

enum SubmissionType {
  EVENT
  VENUE
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum NotificationType {
  SUBMISSION_SUBMITTED
  SUBMISSION_APPROVED
  SUBMISSION_REJECTED
  INVITE_CREATED
  DIGEST_READY
}

enum SavedSearchType {
  NEARBY
  EVENTS_FILTER
}

enum DigestFrequency {
  WEEKLY
}

enum NotificationStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
}

enum NotificationInboxStatus {
  UNREAD
  READ
}

enum EventType {
  EXHIBITION
  OPENING
  TALK
  WORKSHOP
  FAIR
  OTHER
}

enum FavoriteTargetType {
  EVENT
  VENUE
  ARTIST
}

enum FollowTargetType {
  ARTIST
  VENUE
}

enum AssetKind {
  IMAGE
}

model User {
  id                   String            @id @default(uuid()) @db.Uuid
  email                String            @unique
  name                 String?
  imageUrl             String?
  role                 Role              @default(USER)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  favorites            Favorite[]
  venueMemberships     VenueMembership[]
  submissions          Submission[]      @relation("SubmissionSubmitter")
  decidedSubmissions   Submission[]      @relation("SubmissionDecider")
  sentVenueInvites     VenueInvite[]     @relation("VenueInviteInvitedBy")
  ownedAssets          Asset[]
  follows              Follow[]
  perfSnapshotsCreated PerfSnapshot[]
  notifications        Notification[]
  savedSearches        SavedSearch[]
  digestRuns           DigestRun[]
  onboardingState      OnboardingState?
  locationLabel        String?
  locationLat          Float?
  locationLng          Float?
  locationRadiusKm     Int               @default(25)

  @@index([locationLat, locationLng])
}

model OnboardingState {
  id                     String   @id @default(uuid()) @db.Uuid
  userId                 String   @unique @db.Uuid
  completedAt            DateTime?
  hasFollowedSomething   Boolean  @default(false)
  hasVisitedFollowing    Boolean  @default(false)
  hasAcceptedInvite      Boolean  @default(false)
  hasCreatedVenue        Boolean  @default(false)
  hasSubmittedEvent      Boolean  @default(false)
  hasViewedNotifications Boolean  @default(false)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PerfSnapshot {
  id              String   @id @default(uuid()) @db.Uuid
  name            String
  createdAt       DateTime @default(now())
  createdByUserId String?  @db.Uuid
  paramsJson      Json
  explainText     String
  durationMs      Int?
  createdBy       User?    @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([name, createdAt])
  @@index([createdByUserId])
}

model Venue {
  id           String   @id @default(uuid()) @db.Uuid
  name         String
  slug         String   @unique
  description  String?
  addressLine1 String?
  addressLine2 String?
  city         String?
  region       String?
  country      String?
  postcode     String?
  lat          Float?
  lng          Float?
  websiteUrl   String?
  instagramUrl String?
  contactEmail String?
  featuredImageUrl String?
  featuredAssetId String? @db.Uuid
  isPublished  Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  events       Event[]
  memberships  VenueMembership[]
  invites      VenueInvite[]
  submissions  Submission[] @relation("SubmissionVenue")
  targetSubmissions Submission[] @relation("SubmissionTargetVenue")
  featuredAsset Asset? @relation("VenueFeaturedAsset", fields: [featuredAssetId], references: [id], onDelete: SetNull)

  @@index([isPublished])
  @@index([featuredAssetId])
}

model Artist {
  id             String        @id @default(uuid()) @db.Uuid
  name           String
  slug           String        @unique
  bio            String?
  websiteUrl     String?
  instagramUrl   String?
  avatarImageUrl String?
  featuredAssetId String? @db.Uuid
  isPublished    Boolean       @default(false)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  eventArtists   EventArtist[]
  featuredAsset  Asset?        @relation("ArtistFeaturedAsset", fields: [featuredAssetId], references: [id], onDelete: SetNull)

  @@index([isPublished])
  @@index([featuredAssetId])
}

model Event {
  id           String        @id @default(uuid()) @db.Uuid
  title        String
  slug         String        @unique
  description  String?
  startAt      DateTime
  endAt        DateTime?
  timezone     String
  eventType    EventType?
  ticketUrl    String?
  priceText    String?
  isFree       Boolean?
  organizerName String?
  venueId      String?       @db.Uuid
  lat          Float?
  lng          Float?
  isPublished  Boolean       @default(false)
  publishedAt  DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  venue        Venue?        @relation(fields: [venueId], references: [id])
  images       EventImage[]
  eventTags    EventTag[]
  eventArtists EventArtist[]
  submissions  Submission[]

  @@index([startAt])
  @@index([isPublished])
  @@index([venueId])
  @@index([isPublished, startAt])
  @@index([venueId, startAt])
  @@index([publishedAt])
}

model VenueMembership {
  id        String              @id @default(uuid()) @db.Uuid
  userId    String              @db.Uuid
  venueId   String              @db.Uuid
  role      VenueMembershipRole
  createdAt DateTime            @default(now())
  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  venue     Venue               @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@unique([userId, venueId])
  @@index([venueId])
  @@index([userId])
  @@index([venueId, role])
}

model Submission {
  id              String           @id @default(uuid()) @db.Uuid
  type            SubmissionType
  status          SubmissionStatus @default(DRAFT)
  submitterUserId String           @db.Uuid
  venueId         String?          @db.Uuid
  targetEventId   String?          @db.Uuid
  targetVenueId   String?          @db.Uuid
  note            String?
  decisionReason  String?
  decidedByUserId String?          @db.Uuid
  submittedAt     DateTime?
  decidedAt       DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  submitter       User             @relation("SubmissionSubmitter", fields: [submitterUserId], references: [id], onDelete: Cascade)
  venue           Venue?           @relation("SubmissionVenue", fields: [venueId], references: [id], onDelete: SetNull)
  targetEvent     Event?           @relation(fields: [targetEventId], references: [id], onDelete: Cascade)
  targetVenue     Venue?           @relation("SubmissionTargetVenue", fields: [targetVenueId], references: [id], onDelete: Cascade)
  decidedBy       User?            @relation("SubmissionDecider", fields: [decidedByUserId], references: [id], onDelete: SetNull)

  @@unique([targetEventId])
  @@unique([targetVenueId])
  @@index([status, submittedAt])
  @@index([type, status])
  @@index([decidedAt])
  @@index([submitterUserId, createdAt])
}


model VenueInvite {
  id              String            @id @default(uuid()) @db.Uuid
  venueId          String            @db.Uuid
  email            String
  role             VenueMembershipRole
  token            String            @unique
  status           VenueInviteStatus @default(PENDING)
  invitedByUserId  String            @db.Uuid
  createdAt        DateTime          @default(now())
  expiresAt        DateTime
  acceptedAt       DateTime?
  venue            Venue             @relation(fields: [venueId], references: [id], onDelete: Cascade)
  invitedBy        User              @relation("VenueInviteInvitedBy", fields: [invitedByUserId], references: [id], onDelete: Cascade)

  @@index([venueId, status])
  @@index([email, status])
}

model NotificationOutbox {
  id           String             @id @default(uuid()) @db.Uuid
  type         NotificationType
  toEmail      String
  payload      Json
  dedupeKey    String             @unique
  status       NotificationStatus @default(PENDING)
  createdAt    DateTime           @default(now())
  sentAt       DateTime?
  errorMessage String?

  @@index([status, createdAt])
}

model Notification {
  id        String                  @id @default(uuid()) @db.Uuid
  userId    String                  @db.Uuid
  type      NotificationType
  title     String
  body      String
  href      String?
  dedupeKey String                  @unique
  status    NotificationInboxStatus @default(UNREAD)
  createdAt DateTime                @default(now())
  user      User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, status])
}

model SavedSearch {
  id         String           @id @default(uuid()) @db.Uuid
  userId     String           @db.Uuid
  type       SavedSearchType
  name       String
  paramsJson Json
  frequency  DigestFrequency  @default(WEEKLY)
  isEnabled  Boolean          @default(true)
  lastSentAt DateTime?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  digestRuns DigestRun[]

  @@index([userId, createdAt])
  @@index([isEnabled, frequency, lastSentAt])
}

model DigestRun {
  id            String      @id @default(uuid()) @db.Uuid
  savedSearchId String      @db.Uuid
  userId        String      @db.Uuid
  periodKey     String
  createdAt     DateTime    @default(now())
  itemCount     Int
  itemsJson     Json
  savedSearch   SavedSearch @relation(fields: [savedSearchId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([savedSearchId, periodKey])
  @@index([userId, createdAt])
  @@index([savedSearchId, createdAt])
  @@index([periodKey])
}

model Tag {
  id        String     @id @default(uuid()) @db.Uuid
  name      String     @unique
  slug      String     @unique
  createdAt DateTime   @default(now())
  eventTags EventTag[]
}

model EventTag {
  eventId String @db.Uuid
  tagId   String @db.Uuid
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tag     Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([eventId, tagId])
  @@index([tagId])
  @@index([eventId])
  @@index([tagId, eventId])
}

model EventArtist {
  eventId  String @db.Uuid
  artistId String @db.Uuid
  role     String?
  event    Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  artist   Artist @relation(fields: [artistId], references: [id], onDelete: Cascade)

  @@id([eventId, artistId])
  @@index([artistId])
  @@index([eventId])
  @@index([artistId, eventId])
}

model EventImage {
  id        String   @id @default(uuid()) @db.Uuid
  eventId   String   @db.Uuid
  assetId   String?  @db.Uuid
  url       String
  alt       String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  asset     Asset?   @relation(fields: [assetId], references: [id], onDelete: SetNull)

  @@index([assetId])
}

model Asset {
  id          String    @id @default(uuid()) @db.Uuid
  ownerUserId String?   @db.Uuid
  kind        AssetKind
  url         String
  filename    String?
  mime        String?
  sizeBytes   Int?
  width       Int?
  height      Int?
  alt         String?
  createdAt   DateTime  @default(now())
  owner       User?     @relation(fields: [ownerUserId], references: [id], onDelete: SetNull)
  eventImages EventImage[]
  venueFeaturedFor  Venue[] @relation("VenueFeaturedAsset")
  artistFeaturedFor Artist[] @relation("ArtistFeaturedAsset")

  @@index([ownerUserId])
  @@index([createdAt])
}

model Favorite {
  id         String             @id @default(uuid()) @db.Uuid
  userId     String             @db.Uuid
  targetType FavoriteTargetType
  targetId   String             @db.Uuid
  createdAt  DateTime           @default(now())
  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, targetType, targetId])
}

model Follow {
  id         String           @id @default(uuid()) @db.Uuid
  userId     String           @db.Uuid
  targetType FollowTargetType
  targetId   String
  createdAt  DateTime         @default(now())
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, targetType, targetId])
  @@index([userId, createdAt])
  @@index([targetType, targetId])
  @@index([targetType, targetId, createdAt])
}
