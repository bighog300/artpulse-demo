generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // migrations (direct)
}

enum Role {
  USER
  EDITOR
  ADMIN
}

enum VenueMembershipRole {
  OWNER
  EDITOR
}

enum VenueInviteStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}

enum SubmissionType {
  EVENT
  VENUE
  ARTIST
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum SubmissionKind {
  PUBLISH
  REVISION
}

enum NotificationType {
  SUBMISSION_SUBMITTED
  SUBMISSION_APPROVED
  SUBMISSION_REJECTED
  INVITE_CREATED
  DIGEST_READY
}

enum ArtistVenueAssociationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SavedSearchType {
  NEARBY
  EVENTS_FILTER
  ARTWORK
}

enum DigestFrequency {
  WEEKLY
}

enum NotificationStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
}

enum NotificationInboxStatus {
  UNREAD
  READ
}

enum EventType {
  EXHIBITION
  OPENING
  TALK
  WORKSHOP
  FAIR
  OTHER
}

enum FavoriteTargetType {
  EVENT
  VENUE
  ARTIST
}

enum FollowTargetType {
  ARTIST
  VENUE
}

enum EngagementSurface {
  DIGEST
  NEARBY
  SEARCH
  FOLLOWING
}

enum EngagementAction {
  VIEW
  CLICK
  FOLLOW
  SAVE_SEARCH
}

enum AssetKind {
  IMAGE
}

enum BetaAccessRequestStatus {
  PENDING
  APPROVED
  DENIED
}

enum AnalyticsEntityType {
  ARTWORK
  ARTIST
  VENUE
  EVENT
}

enum EditorialNotificationKind {
  COLLECTION_GOES_LIVE_SOON
  COLLECTION_EXPIRES_SOON
  COLLECTION_QA_ISSUES
  RANK_COLLISION_ALERT
}

model User {
  id                   String                @id @default(uuid()) @db.Uuid
  email                String                @unique
  name                 String?
  imageUrl             String?
  role                 Role                  @default(USER)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  favorites            Favorite[]
  venueMemberships     VenueMembership[]
  submissions          Submission[]          @relation("SubmissionSubmitter")
  decidedSubmissions   Submission[]          @relation("SubmissionDecider")
  sentVenueInvites     VenueInvite[]         @relation("VenueInviteInvitedBy")
  ownedAssets          Asset[]
  follows              Follow[]
  perfSnapshotsCreated PerfSnapshot[]
  notifications        Notification[]
  savedSearches        SavedSearch[]
  digestRuns           DigestRun[]
  engagementEvents     EngagementEvent[]
  onboardingState      OnboardingState?
  artistProfile        Artist?
  locationLabel        String?
  locationLat          Float?
  locationLng          Float?
  locationRadiusKm     Int                   @default(25)
  betaAccessRequests   BetaAccessRequest[]
  betaFeedbackEntries  BetaFeedback[]
  adminInvitesCreated  AdminInvite[]         @relation("AdminInviteCreatedBy")
  importMappingPresets ImportMappingPreset[]
  pageViewEvents       PageViewEvent[]

  @@index([locationLat, locationLng])
}

model ImportMappingPreset {
  id          String   @id @default(uuid()) @db.Uuid
  entityType  String
  name        String
  mappingJson Json
  createdById String   @db.Uuid
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@unique([createdById, entityType, name])
  @@index([createdById, entityType, updatedAt])
}

model BetaAccessRequest {
  id        String                  @id @default(uuid()) @db.Uuid
  email     String                  @unique
  note      String?
  status    BetaAccessRequestStatus @default(PENDING)
  createdAt DateTime                @default(now())
  updatedAt DateTime                @updatedAt
  userId    String?                 @db.Uuid
  user      User?                   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([status, createdAt])
}

model BetaFeedback {
  id        String   @id @default(uuid()) @db.Uuid
  email     String?
  pagePath  String?
  message   String
  meta      Json?
  createdAt DateTime @default(now())
  userId    String?  @db.Uuid
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([createdAt])
}

model EngagementEvent {
  id         String            @id @default(uuid()) @db.Uuid
  userId     String?           @db.Uuid
  sessionId  String?
  surface    EngagementSurface
  action     EngagementAction
  targetType String
  targetId   String
  metaJson   Json?
  createdAt  DateTime          @default(now())
  user       User?             @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([surface, createdAt])
  @@index([targetType, targetId, createdAt])
  @@index([userId, surface, createdAt])
}

model OnboardingState {
  id                     String    @id @default(uuid()) @db.Uuid
  userId                 String    @unique @db.Uuid
  completedAt            DateTime?
  hasFollowedSomething   Boolean   @default(false)
  hasVisitedFollowing    Boolean   @default(false)
  hasAcceptedInvite      Boolean   @default(false)
  hasCreatedVenue        Boolean   @default(false)
  hasSubmittedEvent      Boolean   @default(false)
  hasViewedNotifications Boolean   @default(false)
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  user                   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PerfSnapshot {
  id              String   @id @default(uuid()) @db.Uuid
  name            String
  createdAt       DateTime @default(now())
  createdByUserId String?  @db.Uuid
  paramsJson      Json
  explainText     String
  durationMs      Int?
  createdBy       User?    @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([name, createdAt])
  @@index([createdByUserId])
}

model Venue {
  id                 String                   @id @default(uuid()) @db.Uuid
  name               String
  slug               String                   @unique
  description        String?
  addressLine1       String?
  addressLine2       String?
  city               String?
  region             String?
  country            String?
  postcode           String?
  lat                Float?
  lng                Float?
  websiteUrl         String?
  instagramUrl       String?
  contactEmail       String?
  featuredImageUrl   String?
  featuredAssetId    String?                  @db.Uuid
  isPublished        Boolean                  @default(false)
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  events             Event[]
  images             VenueImage[]
  memberships        VenueMembership[]
  invites            VenueInvite[]
  submissions        Submission[]             @relation("SubmissionVenue")
  targetSubmissions  Submission[]             @relation("SubmissionTargetVenue")
  featuredAsset      Asset?                   @relation("VenueFeaturedAsset", fields: [featuredAssetId], references: [id], onDelete: SetNull)
  artistAssociations ArtistVenueAssociation[]
  artworkVenues      ArtworkVenue[]

  @@index([isPublished])
  @@index([featuredAssetId])
}

model Artist {
  id                String                   @id @default(uuid()) @db.Uuid
  userId            String?                  @unique @db.Uuid
  name              String
  slug              String                   @unique
  bio               String?
  websiteUrl        String?
  instagramUrl      String?
  avatarImageUrl    String?
  featuredImageUrl  String?
  featuredAssetId   String?                  @db.Uuid
  isPublished       Boolean                  @default(false)
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  user              User?                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  images            ArtistImage[]
  eventArtists      EventArtist[]
  targetSubmissions Submission[]             @relation("SubmissionTargetArtist")
  featuredAsset     Asset?                   @relation("ArtistFeaturedAsset", fields: [featuredAssetId], references: [id], onDelete: SetNull)
  venueAssociations ArtistVenueAssociation[]
  artworks          Artwork[]
  featuredArtworks  ArtistFeaturedArtwork[]

  @@index([isPublished])
  @@index([featuredAssetId])
}

model ArtistVenueAssociation {
  id                String                       @id @default(uuid()) @db.Uuid
  artistId          String                       @db.Uuid
  venueId           String                       @db.Uuid
  role              String?
  status            ArtistVenueAssociationStatus @default(PENDING)
  message           String?
  createdAt         DateTime                     @default(now())
  updatedAt         DateTime                     @updatedAt
  requestedByUserId String?                      @db.Uuid
  reviewedByUserId  String?                      @db.Uuid
  reviewedAt        DateTime?
  artist            Artist                       @relation(fields: [artistId], references: [id], onDelete: Cascade)
  venue             Venue                        @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@unique([artistId, venueId])
  @@index([venueId, status, createdAt])
  @@index([artistId, status, createdAt])
}

model Event {
  id            String         @id @default(uuid()) @db.Uuid
  title         String
  slug          String         @unique
  description   String?
  startAt       DateTime
  endAt         DateTime?
  timezone      String
  eventType     EventType?
  ticketUrl     String?
  priceText     String?
  isFree        Boolean?
  organizerName String?
  venueId       String?        @db.Uuid
  lat           Float?
  lng           Float?
  isPublished   Boolean        @default(false)
  publishedAt   DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  venue         Venue?         @relation(fields: [venueId], references: [id])
  images        EventImage[]
  eventTags     EventTag[]
  eventArtists  EventArtist[]
  submissions   Submission[]
  artworkEvents ArtworkEvent[]

  @@index([startAt])
  @@index([isPublished])
  @@index([venueId])
  @@index([isPublished, startAt])
  @@index([isPublished, startAt, id])
  @@index([venueId, startAt])
  @@index([publishedAt])
}

model VenueMembership {
  id        String              @id @default(uuid()) @db.Uuid
  userId    String              @db.Uuid
  venueId   String              @db.Uuid
  role      VenueMembershipRole
  createdAt DateTime            @default(now())
  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  venue     Venue               @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@unique([userId, venueId])
  @@index([venueId])
  @@index([userId])
  @@index([venueId, role])
}

model Submission {
  id              String           @id @default(uuid()) @db.Uuid
  type            SubmissionType
  status          SubmissionStatus @default(DRAFT)
  kind            SubmissionKind?
  submitterUserId String           @db.Uuid
  venueId         String?          @db.Uuid
  targetEventId   String?          @db.Uuid
  targetVenueId   String?          @db.Uuid
  targetArtistId  String?          @db.Uuid
  note            String?
  details         Json?
  decisionReason  String?
  decidedByUserId String?          @db.Uuid
  submittedAt     DateTime?
  decidedAt       DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  submitter       User             @relation("SubmissionSubmitter", fields: [submitterUserId], references: [id], onDelete: Cascade)
  venue           Venue?           @relation("SubmissionVenue", fields: [venueId], references: [id], onDelete: SetNull)
  targetEvent     Event?           @relation(fields: [targetEventId], references: [id], onDelete: Cascade)
  targetVenue     Venue?           @relation("SubmissionTargetVenue", fields: [targetVenueId], references: [id], onDelete: Cascade)
  targetArtist    Artist?          @relation("SubmissionTargetArtist", fields: [targetArtistId], references: [id], onDelete: Cascade)
  decidedBy       User?            @relation("SubmissionDecider", fields: [decidedByUserId], references: [id], onDelete: SetNull)

  @@index([targetVenueId, createdAt(sort: Desc)])
  @@index([targetEventId, createdAt(sort: Desc)])
  @@index([targetArtistId, createdAt(sort: Desc)])
  @@index([targetEventId])
  @@index([targetArtistId])
  @@index([status, submittedAt])
  @@index([type, status])
  @@index([decidedAt])
  @@index([submitterUserId, createdAt])
}

model AdminInvite {
  id              String    @id @default(uuid()) @db.Uuid
  email           String
  normalizedEmail String    @unique
  intendedRole    Role      @default(EDITOR)
  tokenHash       String    @unique
  createdById     String    @db.Uuid
  createdAt       DateTime  @default(now())
  expiresAt       DateTime
  acceptedAt      DateTime?
  revokedAt       DateTime?
  createdBy       User      @relation("AdminInviteCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([normalizedEmail, createdAt])
  @@index([expiresAt])
}

model VenueInvite {
  id              String              @id @default(uuid()) @db.Uuid
  venueId         String              @db.Uuid
  email           String
  role            VenueMembershipRole
  token           String              @unique
  status          VenueInviteStatus   @default(PENDING)
  invitedByUserId String              @db.Uuid
  createdAt       DateTime            @default(now())
  expiresAt       DateTime
  acceptedAt      DateTime?
  venue           Venue               @relation(fields: [venueId], references: [id], onDelete: Cascade)
  invitedBy       User                @relation("VenueInviteInvitedBy", fields: [invitedByUserId], references: [id], onDelete: Cascade)

  @@index([venueId, status])
  @@index([email, status])
}

model NotificationOutbox {
  id           String             @id @default(uuid()) @db.Uuid
  type         NotificationType
  toEmail      String
  payload      Json
  dedupeKey    String             @unique
  status       NotificationStatus @default(PENDING)
  createdAt    DateTime           @default(now())
  sentAt       DateTime?
  errorMessage String?

  @@index([status, createdAt])
}

model Notification {
  id        String                  @id @default(uuid()) @db.Uuid
  userId    String                  @db.Uuid
  type      NotificationType
  title     String
  body      String
  href      String?
  dedupeKey String                  @unique
  status    NotificationInboxStatus @default(UNREAD)
  createdAt DateTime                @default(now())
  user      User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, status])
}

model SavedSearch {
  id         String          @id @default(uuid()) @db.Uuid
  userId     String          @db.Uuid
  type       SavedSearchType
  name       String
  paramsJson Json
  frequency  DigestFrequency @default(WEEKLY)
  isEnabled  Boolean         @default(true)
  lastSentAt DateTime?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  digestRuns DigestRun[]

  @@index([userId, createdAt])
  @@index([isEnabled, frequency, lastSentAt])
}

model DigestRun {
  id            String      @id @default(uuid()) @db.Uuid
  savedSearchId String      @db.Uuid
  userId        String      @db.Uuid
  periodKey     String
  createdAt     DateTime    @default(now())
  itemCount     Int
  itemsJson     Json
  savedSearch   SavedSearch @relation(fields: [savedSearchId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([savedSearchId, periodKey])
  @@index([userId, createdAt])
  @@index([savedSearchId, createdAt])
  @@index([periodKey])
}

model Tag {
  id        String     @id @default(uuid()) @db.Uuid
  name      String     @unique
  slug      String     @unique
  createdAt DateTime   @default(now())
  eventTags EventTag[]
}

model EventTag {
  eventId String @db.Uuid
  tagId   String @db.Uuid
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tag     Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([eventId, tagId])
  @@index([tagId])
  @@index([eventId])
  @@index([tagId, eventId])
}

model EventArtist {
  eventId   String   @db.Uuid
  artistId  String   @db.Uuid
  role      String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  artist    Artist   @relation(fields: [artistId], references: [id], onDelete: Cascade)

  @@id([eventId, artistId])
  @@index([artistId, sortOrder])
  @@index([artistId, eventId])
  @@index([eventId, sortOrder])
}

model ArtistImage {
  id          String   @id @default(uuid()) @db.Uuid
  artistId    String   @db.Uuid
  assetId     String?  @db.Uuid
  url         String
  alt         String?
  width       Int?
  height      Int?
  contentType String?
  sizeBytes   Int?
  sortOrder   Int      @default(0)
  isPrimary   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  artist      Artist   @relation(fields: [artistId], references: [id], onDelete: Cascade)
  asset       Asset?   @relation(fields: [assetId], references: [id], onDelete: SetNull)

  @@index([artistId, sortOrder])
  @@index([artistId, isPrimary])
  @@index([assetId])
}

model EventImage {
  id          String   @id @default(uuid()) @db.Uuid
  eventId     String   @db.Uuid
  assetId     String?  @db.Uuid
  url         String
  alt         String?
  width       Int?
  height      Int?
  contentType String?
  sizeBytes   Int?
  sortOrder   Int      @default(0)
  isPrimary   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  asset       Asset?   @relation(fields: [assetId], references: [id], onDelete: SetNull)

  @@index([assetId])
  @@index([eventId, sortOrder])
  @@index([eventId, isPrimary])
}

model VenueImage {
  id          String   @id @default(uuid()) @db.Uuid
  venueId     String   @db.Uuid
  assetId     String?  @db.Uuid
  url         String
  alt         String?
  width       Int?
  height      Int?
  contentType String?
  sizeBytes   Int?
  sortOrder   Int      @default(0)
  isPrimary   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  venue       Venue    @relation(fields: [venueId], references: [id], onDelete: Cascade)
  asset       Asset?   @relation(fields: [assetId], references: [id], onDelete: SetNull)

  @@index([assetId])
  @@index([venueId, sortOrder])
  @@index([venueId, isPrimary])
}

model Asset {
  id                 String         @id @default(uuid()) @db.Uuid
  ownerUserId        String?        @db.Uuid
  kind               AssetKind
  url                String
  filename           String?
  mime               String?
  sizeBytes          Int?
  width              Int?
  height             Int?
  alt                String?
  createdAt          DateTime       @default(now())
  owner              User?          @relation(fields: [ownerUserId], references: [id], onDelete: SetNull)
  eventImages        EventImage[]
  venueImages        VenueImage[]
  artistImages       ArtistImage[]
  venueFeaturedFor   Venue[]        @relation("VenueFeaturedAsset")
  artistFeaturedFor  Artist[]       @relation("ArtistFeaturedAsset")
  artworkFeaturedFor Artwork[]      @relation("ArtworkFeaturedAsset")
  artworkImages      ArtworkImage[]

  @@index([ownerUserId])
  @@index([createdAt])
}

model Artwork {
  id              String         @id @default(uuid()) @db.Uuid
  artistId        String         @db.Uuid
  title           String
  slug            String?        @unique
  description     String?
  year            Int?
  medium          String?
  dimensions      String?
  priceAmount     Int?
  currency        String?
  isPublished     Boolean        @default(false)
  featuredAssetId String?        @db.Uuid
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  artist          Artist         @relation(fields: [artistId], references: [id], onDelete: Cascade)
  featuredAsset   Asset?         @relation("ArtworkFeaturedAsset", fields: [featuredAssetId], references: [id], onDelete: SetNull)
  images          ArtworkImage[]
  venues          ArtworkVenue[]
  events          ArtworkEvent[]
  featuredBy      ArtistFeaturedArtwork[]
  curatedItems    CuratedCollectionItem[]

  @@index([artistId])
  @@index([isPublished])
  @@index([artistId, isPublished, updatedAt])
  @@index([featuredAssetId])
}

model ArtistFeaturedArtwork {
  id        String   @id @default(uuid()) @db.Uuid
  artistId  String   @db.Uuid
  artworkId String   @db.Uuid
  sortOrder Int
  createdAt DateTime @default(now())
  artist    Artist   @relation(fields: [artistId], references: [id], onDelete: Cascade)
  artwork   Artwork  @relation(fields: [artworkId], references: [id], onDelete: Cascade)

  @@unique([artistId, artworkId])
  @@index([artistId, sortOrder])
}

model CuratedCollection {
  id              String                  @id @default(uuid()) @db.Uuid
  slug            String                  @unique
  title           String
  description     String?
  isPublished     Boolean                 @default(false)
  publishStartsAt DateTime?
  publishEndsAt   DateTime?
  homeRank        Int?
  showOnHome      Boolean                 @default(true)
  showOnArtwork   Boolean                 @default(true)
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  items           CuratedCollectionItem[]

  @@index([isPublished, publishStartsAt, publishEndsAt])
  @@index([homeRank])
  @@index([updatedAt])
}

model EditorialNotificationLog {
  id          String                   @id @default(uuid()) @db.Uuid
  kind        EditorialNotificationKind
  fingerprint String                   @unique
  payloadJson Json
  sentTo      String[]
  createdAt   DateTime                 @default(now())
}

model CuratedCollectionItem {
  id           String            @id @default(uuid()) @db.Uuid
  collectionId String            @db.Uuid
  artworkId    String            @db.Uuid
  sortOrder    Int
  createdAt    DateTime          @default(now())
  collection   CuratedCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  artwork      Artwork           @relation(fields: [artworkId], references: [id], onDelete: Cascade)

  @@unique([collectionId, artworkId])
  @@index([collectionId, sortOrder])
}

model ArtworkImage {
  id        String   @id @default(uuid()) @db.Uuid
  artworkId String   @db.Uuid
  assetId   String   @db.Uuid
  alt       String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  artwork   Artwork  @relation(fields: [artworkId], references: [id], onDelete: Cascade)
  asset     Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([artworkId, assetId])
  @@index([artworkId])
  @@index([assetId])
  @@index([artworkId, sortOrder])
}

model ArtworkVenue {
  id        String   @id @default(uuid()) @db.Uuid
  artworkId String   @db.Uuid
  venueId   String   @db.Uuid
  createdAt DateTime @default(now())
  artwork   Artwork  @relation(fields: [artworkId], references: [id], onDelete: Cascade)
  venue     Venue    @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@unique([artworkId, venueId])
  @@index([artworkId])
  @@index([venueId])
  @@index([venueId, artworkId])
}

model ArtworkEvent {
  id        String   @id @default(uuid()) @db.Uuid
  artworkId String   @db.Uuid
  eventId   String   @db.Uuid
  createdAt DateTime @default(now())
  artwork   Artwork  @relation(fields: [artworkId], references: [id], onDelete: Cascade)
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([artworkId, eventId])
  @@index([artworkId])
  @@index([eventId])
  @@index([eventId, artworkId])
}

model PageViewEvent {
  id         String              @id @default(uuid()) @db.Uuid
  entityType AnalyticsEntityType
  entityId   String              @db.Uuid
  occurredAt DateTime            @default(now())
  day        DateTime            @db.Date
  viewerHash String?
  userId     String?             @db.Uuid
  user       User?               @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([entityType, entityId, occurredAt])
  @@index([day, entityType])
  @@index([entityType, entityId, day])
  @@index([userId, occurredAt])
}

model PageViewDaily {
  id         String              @id @default(uuid()) @db.Uuid
  entityType AnalyticsEntityType
  entityId   String              @db.Uuid
  day        DateTime            @db.Date
  views      Int                 @default(0)

  @@unique([entityType, entityId, day])
  @@index([entityType, entityId, day])
  @@index([day, entityType])
}

model Favorite {
  id         String             @id @default(uuid()) @db.Uuid
  userId     String             @db.Uuid
  targetType FavoriteTargetType
  targetId   String             @db.Uuid
  createdAt  DateTime           @default(now())
  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, targetType, targetId])
  @@index([targetType, targetId])
  @@index([targetType, createdAt, targetId])
}

model Follow {
  id         String           @id @default(uuid()) @db.Uuid
  userId     String           @db.Uuid
  targetType FollowTargetType
  targetId   String
  createdAt  DateTime         @default(now())
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, targetType, targetId])
  @@index([userId, createdAt])
  @@index([targetType, targetId])
  @@index([targetType, targetId, createdAt])
}

model AdminAuditLog {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  actorEmail String
  action     String
  targetType String
  targetId   String?
  metadata   Json?
  ip         String?
  userAgent  String?

  @@index([createdAt])
  @@index([actorEmail, createdAt])
  @@index([action, createdAt])
  @@index([targetType, createdAt])
}

model JobRun {
  id         String    @id @default(cuid())
  createdAt  DateTime  @default(now())
  startedAt  DateTime?
  finishedAt DateTime?
  name       String
  status     String
  trigger    String
  actorEmail String?
  message    String?
  metadata   Json?

  @@index([createdAt])
  @@index([name, createdAt])
  @@index([status, createdAt])
  @@index([actorEmail, createdAt])
}
